<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detection of Annotation Anomalies • scDiagnostics</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Detection of Annotation Anomalies">
<meta property="og:description" content="scDiagnostics">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">scDiagnostics</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.99.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/scDiagnostics.html">Geting Started with scDiagnostics</a>
    </li>
    <li>
      <a href="../articles/VisualizationTools.html">Visualization of Cell Type Annotations</a>
    </li>
    <li>
      <a href="../articles/QCandAnnotationScores.html">Visualization of QC and Annotation Scores</a>
    </li>
    <li>
      <a href="../articles/DatasetAlignment.html">Evaluation of Dataset and Marker Gene Alignment</a>
    </li>
    <li>
      <a href="../articles/StatisticalMeasures.html">Statistical Measures to Assess Dataset Alignment</a>
    </li>
    <li>
      <a href="../articles/AnnotationAnomalies.html">Detection of Annotation Anomalies</a>
    </li>
    <li>
      <a href="../articles/CellDistancesDiagnostics.html">Calculation of Distances Between Specific Cells and Cell Populations</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ccb-hms/scDiagnostics/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Detection of Annotation Anomalies</h1>
                        <h4 data-toc-skip class="author">Anthony
Christidis</h4>
            <address class="author_afil">
      Core for Computational Biomedicine, Harvard Medical
School<br><a class="author_email" href="mailto:#"></a><a href="mailto:anthony-alexander_christidis@hms.harvard.edu" class="email">anthony-alexander_christidis@hms.harvard.edu</a>
      </address>
                              <h4 data-toc-skip class="author">Andrew
Ghazi</h4>
            <address class="author_afil">
      Core for Computational Biomedicine, Harvard Medical
School<br><h4 data-toc-skip class="author">Smriti
Chawla</h4>
            <address class="author_afil">
      Core for Computational Biomedicine, Harvard Medical
School<br><h4 data-toc-skip class="author">Nitesh
Turaga</h4>
            <address class="author_afil">
      Core for Computational Biomedicine, Harvard Medical
School<br><h4 data-toc-skip class="author">Ludwig
Geistlinger</h4>
            <address class="author_afil">
      Core for Computational Biomedicine, Harvard Medical
School<br><h4 data-toc-skip class="author">Robert
Gentleman</h4>
            <address class="author_afil">
      Core for Computational Biomedicine, Harvard Medical
School<br><small class="dont-index">Source: <a href="https://github.com/ccb-hms/scDiagnostics/blob/HEAD/vignettes/AnnotationAnomalies.Rmd" class="external-link"><code>vignettes/AnnotationAnomalies.Rmd</code></a></small>
      <div class="hidden name"><code>AnnotationAnomalies.Rmd</code></div>

    </address>
</address>
</address>
</address>
</address>
</div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>scDiagnostics</code> package provides powerful tools for
anomaly detection in single-cell data, enabling researchers to identify
and analyze outliers in complex datasets. Central to this process is the
<code>detectAnomaly</code> function, which integrates dimensionality
reduction through Principal Component Analysis (PCA) with the robust
capabilities of the isolation forest algorithm.</p>
<p>In single-cell analysis, detecting anomalies is crucial for
identifying potential data issues, such as mislabeled cells, technical
artifacts, or biologically distinct subpopulations. The
<code>detectAnomaly</code> function offers a versatile approach to
anomaly detection by allowing users to project data onto a PCA space and
apply isolation forests to uncover outliers. Whether working solely with
a reference dataset or comparing a query dataset against a
well-characterized reference, this function provides detailed insights
into potential anomalies.</p>
<p>This vignette illustrates how to effectively use the
<code>detectAnomaly</code> function in various scenarios. We explore
both cell-type-specific and global anomaly detection, demonstrate the
utility of integrating query data with reference data, and offer
guidance on interpreting the results. Additionally, we show how to
extend this analysis by combining anomaly detection with PCA loadings
using the <code>calculateCellSimilarityPCA</code> function, providing a
comprehensive toolkit for investigating the structure and quality of
single-cell data.</p>
<p>Whether you’re looking to enhance the accuracy of your cell type
annotations or identify subtle deviations in your data, the tools
provided by <code>scDiagnostics</code> will empower you to conduct
thorough and nuanced assessments of your single-cell datasets.</p>
</div>
<div class="section level2">
<h2 id="preliminaries">Preliminaries<a class="anchor" aria-label="anchor" href="#preliminaries"></a>
</h2>
<p>In the context of the <code>scDiagnostics</code> package, the
following datasets illustrate the application of these tools:</p>
<ul>
<li><p><code>reference_data</code>: A curated and processed dataset
containing expert-assigned cell type annotations. This dataset serves as
a reference for comparison and can be used alone to detect anomalies
within the reference annotations.</p></li>
<li><p><code>query_data</code>: A dataset that also includes
expert-assigned cell type annotations, but additionally features
annotations generated by the <code>SingleR</code> package. This allows
for the comparison of expert annotations with those produced by an
automated method to detect inconsistencies or anomalies.</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load library</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ccb-hms/scDiagnostics" class="external-link">scDiagnostics</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load datasets</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"reference_data"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"query_data"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>By using these datasets, you can leverage the package’s tools to
compare annotations between <code>reference_data</code> and
<code>query_data</code>, or analyze <code>reference_data</code> alone to
identify potential issues. The package’s flexibility supports various
analysis scenarios, whether you need to assess overall annotation
quality or focus on specific cell types.</p>
<p>Through these capabilities, <code>scDiagnostics</code> empowers you
to perform thorough and nuanced assessments of cell type annotations,
enhancing the accuracy and reliability of your analyses.</p>
</div>
<div class="section level2">
<h2 id="the-detectanomaly-function">The <code>detectAnomaly</code> Function<a class="anchor" aria-label="anchor" href="#the-detectanomaly-function"></a>
</h2>
<div class="section level3">
<h3 id="function-overview">Function Overview<a class="anchor" aria-label="anchor" href="#function-overview"></a>
</h3>
<div class="section level4">
<h4 id="description">Description<a class="anchor" aria-label="anchor" href="#description"></a>
</h4>
<p>The <code>detectAnomaly</code> function integrates dimensionality
reduction via PCA with the isolation forest algorithm to detect
anomalies in single-cell data. By projecting both reference and query
datasets (if available) onto a PCA space, the function leverages the
isolation forest method to pinpoint outliers or deviations in the data.
This approach is highly versatile:</p>
<ul>
<li>
<strong>Reference Only</strong>: Compute anomaly scores solely for
the reference dataset to identify potential issues within the reference
itself.</li>
<li>
<strong>Reference and Query</strong>: Compare the query dataset
against the reference to find anomalies in the query data that may not
align with the established reference.</li>
<li>
<strong>Global and Specific Analysis</strong>: Assess anomalies at a
global level or focus on specific cell types to gain targeted insights
into your data. The function also provides detailed visualizations and
statistical outputs to help you interpret the anomalies detected.</li>
</ul>
</div>
<div class="section level4">
<h4 id="parameters">Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h4>
<p>The function takes a <strong>SingleCellExperiment</strong> object as
<strong>reference_data</strong> to build a PCA space and train an
isolation forest model, with an optional <strong>query_data</strong> for
projecting onto this PCA space for anomaly detection. You can specify
cell type annotations through <strong>ref_cell_type_col</strong> and
<strong>query_cell_type_col</strong>, and limit the analysis to certain
cell types using the <strong>cell_types</strong> parameter. The function
allows you to select specific principal components via
<strong>pc_subset</strong>, adjust the number of trees with
<strong>n_tree</strong>, and set an <strong>anomaly_threshold</strong>
for classifying anomalies.</p>
</div>
<div class="section level4">
<h4 id="return-value">Return Value<a class="anchor" aria-label="anchor" href="#return-value"></a>
</h4>
<p>The function returns several outputs: <strong>anomaly_scores</strong>
indicating the likelihood of each cell being an anomaly, a
<strong>logical</strong> vector (<strong>anomaly</strong>) identifying
these anomalies, PCA projections for the reference data
(<strong>reference_mat_subset</strong>) and optionally for the query
data (<strong>query_mat_subset</strong>), and the proportion of variance
explained by the selected principal components
(<strong>var_explained</strong>).</p>
</div>
</div>
<div class="section level3">
<h3 id="detectanomaly-examples">
<code>detectAnomaly</code> Examples<a class="anchor" aria-label="anchor" href="#detectanomaly-examples"></a>
</h3>
<div class="section level4">
<h4 id="anomaly-detection-with-reference-and-query-data">Anomaly Detection with Reference and Query Data<a class="anchor" aria-label="anchor" href="#anomaly-detection-with-reference-and-query-data"></a>
</h4>
<p>This section demonstrates how to use the <code>detectAnomaly</code>
function when both reference and query datasets are provided. It
includes examples of analyzing anomalies for specific cell types and
globally across all data.</p>
<div class="section level5">
<h5 id="example-1-cell-type-specific-anomaly-detection">Example 1: Cell-Type Specific Anomaly Detection<a class="anchor" aria-label="anchor" href="#example-1-cell-type-specific-anomaly-detection"></a>
</h5>
<p>In this example, we analyze anomalies specifically for the “CD4” cell
type. The anomaly scores are trained on the PCA projections of the “CD4”
cells from the reference dataset. If query data is provided, anomaly
scores for the query data are predicted based on the PCA projections of
the query data onto the reference PCA space for the “CD4” cell type.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform anomaly detection</span></span>
<span><span class="va">anomaly_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/detectAnomaly.html">detectAnomaly</a></span><span class="op">(</span>reference_data <span class="op">=</span> <span class="va">reference_data</span>, </span>
<span>                                query_data <span class="op">=</span> <span class="va">query_data</span>, </span>
<span>                                ref_cell_type_col <span class="op">=</span> <span class="st">"expert_annotation"</span>, </span>
<span>                                query_cell_type_col <span class="op">=</span> <span class="st">"SingleR_annotation"</span>,</span>
<span>                                pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>                                n_tree <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                                anomaly_treshold <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the output for the "CD4" cell type</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">anomaly_output</span>, </span>
<span>     cell_type <span class="op">=</span> <span class="st">"CD4"</span>, </span>
<span>     pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, </span>
<span>     data_type <span class="op">=</span> <span class="st">"query"</span><span class="op">)</span></span></code></pre></div>
<p><img src="AnnotationAnomalies_files/figure-html/unnamed-chunk-2-1.png" width="100%" style="display: block; margin: auto;">
In this example, we analyze anomalies specifically for the “CD4” cell
type. The anomaly scores are trained on the PCA projections of the “CD4”
cells from the reference dataset. If query data is provided, anomaly
scores for the query data are predicted based on the PCA projections of
the query data onto the reference PCA space for the “CD4” cell type.</p>
<p>Notice that if we use the expert_annotation column in the query_data,
there are far less cells deemed to be anomalies based on the isolation
forest model.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform anomaly detection</span></span>
<span><span class="va">anomaly_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/detectAnomaly.html">detectAnomaly</a></span><span class="op">(</span>reference_data <span class="op">=</span> <span class="va">reference_data</span>, </span>
<span>                                query_data <span class="op">=</span> <span class="va">query_data</span>, </span>
<span>                                ref_cell_type_col <span class="op">=</span> <span class="st">"expert_annotation"</span>, </span>
<span>                                query_cell_type_col <span class="op">=</span> <span class="st">"expert_annotation"</span>,</span>
<span>                                pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>                                n_tree <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                                anomaly_treshold <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the output for the "CD4" cell type</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">anomaly_output</span>, </span>
<span>     cell_type <span class="op">=</span> <span class="st">"CD4"</span>, </span>
<span>     pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, </span>
<span>     data_type <span class="op">=</span> <span class="st">"query"</span><span class="op">)</span></span></code></pre></div>
<p><img src="AnnotationAnomalies_files/figure-html/unnamed-chunk-3-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level5">
<h5 id="example-2-global-anomaly-detection">Example 2: Global Anomaly Detection<a class="anchor" aria-label="anchor" href="#example-2-global-anomaly-detection"></a>
</h5>
<p>Here, we perform global anomaly detection by setting
<code>cell_type = NULL</code>. In this case, the isolation forest is
trained on PCA projections of all cells in the reference data combined.
The global anomaly scores are then computed for both reference and query
datasets.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform anomaly detection</span></span>
<span><span class="va">anomaly_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/detectAnomaly.html">detectAnomaly</a></span><span class="op">(</span>reference_data <span class="op">=</span> <span class="va">reference_data</span>, </span>
<span>                                query_data <span class="op">=</span> <span class="va">query_data</span>, </span>
<span>                                ref_cell_type_col <span class="op">=</span> <span class="st">"expert_annotation"</span>, </span>
<span>                                query_cell_type_col <span class="op">=</span> <span class="st">"SingleR_annotation"</span>,</span>
<span>                                pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>                                n_tree <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                                anomaly_treshold <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the global anomaly scores</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">anomaly_output</span>, </span>
<span>     cell_type <span class="op">=</span> <span class="cn">NULL</span>,  <span class="co"># Plot all cell types</span></span>
<span>     pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, </span>
<span>     data_type <span class="op">=</span> <span class="st">"query"</span><span class="op">)</span></span></code></pre></div>
<p><img src="AnnotationAnomalies_files/figure-html/unnamed-chunk-4-1.png" width="100%" style="display: block; margin: auto;">
Setting <code>cell_type = NULL</code> means that the anomaly detection
is done globally. The isolation forest is trained on PCA projections of
all cells from the reference dataset. Anomaly scores are then predicted
for the query data based on these global PCA projections. The plot
provides a comprehensive view of anomalies across all cell types in the
query dataset.</p>
</div>
</div>
<div class="section level4">
<h4 id="anomaly-detection-with-reference-data-only">Anomaly Detection with Reference Data Only<a class="anchor" aria-label="anchor" href="#anomaly-detection-with-reference-data-only"></a>
</h4>
<p>This section demonstrates how to use the detectAnomaly function when
only the reference dataset is provided. It includes both cell-type
specific and global anomaly detection within the reference data
itself.</p>
<div class="section level5">
<h5 id="example-3-cell-type-specific-anomaly-detection-in-reference-data">Example 3: Cell-Type Specific Anomaly Detection in Reference
Data<a class="anchor" aria-label="anchor" href="#example-3-cell-type-specific-anomaly-detection-in-reference-data"></a>
</h5>
<p>In this example, we analyze anomalies for the “CD4” cell type within
the reference data. The isolation forest is trained on the PCA
projections of the “CD4” cells, and the anomaly scores are computed for
these cells.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform anomaly detection on reference data</span></span>
<span><span class="va">anomaly_output_ref_only</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/detectAnomaly.html">detectAnomaly</a></span><span class="op">(</span>reference_data <span class="op">=</span> <span class="va">reference_data</span>, </span>
<span>                                         ref_cell_type_col <span class="op">=</span> <span class="st">"expert_annotation"</span>, </span>
<span>                                         pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>                                         n_tree <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                                         anomaly_treshold <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the output for the "CD4" cell type in the reference data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">anomaly_output_ref_only</span>, </span>
<span>     cell_type <span class="op">=</span> <span class="st">"CD4"</span>, </span>
<span>     pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, </span>
<span>     data_type <span class="op">=</span> <span class="st">"reference"</span><span class="op">)</span></span></code></pre></div>
<p><img src="AnnotationAnomalies_files/figure-html/unnamed-chunk-5-1.png" width="100%" style="display: block; margin: auto;">
For the “CD4” cell type, anomaly scores are trained on the PCA
projections of the “CD4” cells within the reference dataset. The plot
visualizes these anomaly scores specifically for “CD4” cells in the
reference data.</p>
</div>
<div class="section level5">
<h5 id="example-4-global-anomaly-detection-in-reference-data">Example 4: Global Anomaly Detection in Reference Data<a class="anchor" aria-label="anchor" href="#example-4-global-anomaly-detection-in-reference-data"></a>
</h5>
<p>Here, we perform global anomaly detection using only the reference
dataset. The isolation forest is trained on PCA projections of all cells
combined from the reference data to identify global outliers.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform global anomaly detection on reference data only</span></span>
<span><span class="va">anomaly_output_ref_only_global</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/detectAnomaly.html">detectAnomaly</a></span><span class="op">(</span>reference_data <span class="op">=</span> <span class="va">reference_data</span>, </span>
<span>                                                ref_cell_type_col <span class="op">=</span> <span class="st">"expert_annotation"</span>, </span>
<span>                                                cell_types <span class="op">=</span> <span class="cn">NULL</span>,  <span class="co"># Global analysis</span></span>
<span>                                                pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>                                                n_tree <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                                                anomaly_treshold <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the global anomaly scores for the reference data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">anomaly_output_ref_only_global</span>, </span>
<span>     cell_type <span class="op">=</span> <span class="cn">NULL</span>,  <span class="co"># Plot all cell types</span></span>
<span>     pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, </span>
<span>     data_type <span class="op">=</span> <span class="st">"reference"</span><span class="op">)</span></span></code></pre></div>
<p><img src="AnnotationAnomalies_files/figure-html/unnamed-chunk-6-1.png" width="100%" style="display: block; margin: auto;">
Setting <code>cell_type = NULL</code> in the reference data analysis
results in global anomaly detection. The isolation forest is trained on
PCA projections of all cells from the reference data combined. Anomalies
are then identified across all cell types, and the plot provides a
global view of these anomalies within the reference dataset.</p>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="integrating-anomaly-detection-with-cell-similarity-analysis-using-pca-loadings">Integrating Anomaly Detection with Cell Similarity Analysis Using
PCA Loadings<a class="anchor" aria-label="anchor" href="#integrating-anomaly-detection-with-cell-similarity-analysis-using-pca-loadings"></a>
</h2>
<p>The <code>detectAnomaly</code> function identifies anomalous cells in
a dataset by detecting outliers based on PCA results. Once anomalies are
detected, <code>calculateCellSimilarityPCA</code> evaluates how these
outliers influence principal component directions. This analysis helps
determine if anomalous cells significantly impact later PCs, which
capture finer variations in the data. By combining these functions, you
can both pinpoint anomalies and understand their effect on PCA
directions, providing deeper insights into the data structure.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Detect anomalies and select top anomalies for further analysis</span></span>
<span><span class="va">anomaly_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/detectAnomaly.html">detectAnomaly</a></span><span class="op">(</span>reference_data <span class="op">=</span> <span class="va">reference_data</span>, </span>
<span>                                query_data <span class="op">=</span> <span class="va">query_data</span>,</span>
<span>                                ref_cell_type_col <span class="op">=</span> <span class="st">"expert_annotation"</span>, </span>
<span>                                query_cell_type_col <span class="op">=</span> <span class="st">"SingleR_annotation"</span>,</span>
<span>                                pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>                                n_tree <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                                anomaly_treshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Select the top 6 anomalies based on the anomaly scores</span></span>
<span><span class="va">top6_anomalies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">anomaly_output</span><span class="op">$</span><span class="va">Combined</span><span class="op">$</span><span class="va">reference_anomaly_scores</span>, </span>
<span>                             decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate cosine similarity between the top anomalies and top 25 PCs</span></span>
<span><span class="va">cosine_similarities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculateCellSimilarityPCA.html">calculateCellSimilarityPCA</a></span><span class="op">(</span><span class="va">reference_data</span>, </span>
<span>                                                  cell_names <span class="op">=</span> <span class="va">top6_anomalies</span>, </span>
<span>                                                  pc_subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">25</span>, </span>
<span>                                                  n_top_vars <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the cosine similarities across PCs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cosine_similarities</span>, pc_subset <span class="op">=</span> <span class="fl">15</span><span class="op">:</span><span class="fl">25</span><span class="op">)</span></span></code></pre></div>
<p><img src="AnnotationAnomalies_files/figure-html/unnamed-chunk-7-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This vignette section provides a comprehensive overview of how to use
the <code>detectAnomaly</code> function for both reference and query
datasets, with specific and global anomaly detection examples, along
with how to visualize the results using the plot method. With
<code>calculateCellSimilarityPCA</code>, we can assess whether cells
have a large effect on the loadings of PC vectors, affecting the
downstream analysis.</p>
<hr>
</div>
<div class="section level2">
<h2 id="r-session-info">R Session Info<a class="anchor" aria-label="anchor" href="#r-session-info"></a>
</h2>
<pre><code>R version 4.4.0 (2024-04-24 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 22631)

Matrix products: default


locale:
[1] LC_COLLATE=English_United States.utf8 
[2] LC_CTYPE=English_United States.utf8   
[3] LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.utf8    

time zone: America/New_York
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] scDiagnostics_0.99.6 BiocStyle_2.32.0    

loaded via a namespace (and not attached):
 [1] SummarizedExperiment_1.34.0 gtable_0.3.5               
 [3] xfun_0.44                   bslib_0.7.0                
 [5] ggplot2_3.5.1               htmlwidgets_1.6.4          
 [7] Biobase_2.64.0              lattice_0.22-6             
 [9] generics_0.1.3              vctrs_0.6.5                
[11] tools_4.4.0                 stats4_4.4.0               
[13] parallel_4.4.0              tibble_3.2.1               
[15] fansi_1.0.6                 highr_0.11                 
[17] pkgconfig_2.0.3             Matrix_1.7-0               
[19] desc_1.4.3                  S4Vectors_0.42.0           
[21] lifecycle_1.0.4             GenomeInfoDbData_1.2.12    
[23] farver_2.1.2                compiler_4.4.0             
[25] textshaping_0.4.0           munsell_0.5.1              
[27] GenomeInfoDb_1.40.1         htmltools_0.5.8.1          
[29] sass_0.4.9                  yaml_2.3.8                 
[31] pkgdown_2.0.9               pillar_1.9.0               
[33] crayon_1.5.2                jquerylib_0.1.4            
[35] SingleCellExperiment_1.26.0 cachem_1.1.0               
[37] DelayedArray_0.30.1         abind_1.4-5                
[39] tidyselect_1.2.1            digest_0.6.35              
[41] dplyr_1.1.4                 purrr_1.0.2                
[43] bookdown_0.39               labeling_0.4.3             
[45] fastmap_1.2.0               grid_4.4.0                 
[47] colorspace_2.1-0            cli_3.6.2                  
[49] SparseArray_1.4.8           magrittr_2.0.3             
[51] S4Arrays_1.4.1              utf8_1.2.4                 
[53] withr_3.0.0                 UCSC.utils_1.0.0           
[55] scales_1.3.0                rmarkdown_2.27             
[57] XVector_0.44.0              httr_1.4.7                 
[59] matrixStats_1.3.0           ragg_1.3.2                 
[61] isotree_0.6.1-1             memoise_2.0.1              
[63] evaluate_0.23               knitr_1.46                 
[65] GenomicRanges_1.56.0        IRanges_2.38.0             
[67] rlang_1.1.3                 Rcpp_1.0.12                
[69] glue_1.7.0                  BiocManager_1.30.23        
[71] BiocGenerics_0.50.0         rstudioapi_0.16.0          
[73] jsonlite_1.8.8              R6_2.5.1                   
[75] MatrixGenerics_1.16.0       systemfonts_1.1.0          
[77] fs_1.6.4                    zlibbioc_1.50.0            </code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Anthony Christidis, Andrew Ghazi, Smriti Chawla, Ludwig Geistlinger, Robert Gentleman.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
