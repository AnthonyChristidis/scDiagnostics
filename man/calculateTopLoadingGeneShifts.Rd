% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculateTopLoadingGeneShifts.R,
%   R/plot.calculateTopLoadingGeneShifts.R
\name{calculateTopLoadingGeneShifts}
\alias{calculateTopLoadingGeneShifts}
\alias{plot.calculateTopLoadingGeneShiftsObject}
\title{Calculate Top Loading Gene Expression Shifts}
\usage{
calculateTopLoadingGeneShifts(
  query_data,
  reference_data,
  query_cell_type_col,
  ref_cell_type_col,
  cell_types = NULL,
  pc_subset = 1:5,
  n_top_loadings = 50,
  p_value_threshold = 0.05,
  adjust_method = "fdr",
  assay_name = "logcounts",
  max_cells = 2500
)

\method{plot}{calculateTopLoadingGeneShiftsObject}(
  x,
  cell_type,
  pc_subset = 1:3,
  plot_by = c("p_adjusted", "top_loading"),
  n_genes = 10,
  significance_threshold = 0.05,
  ...
)
}
\arguments{
\item{query_data}{A \code{\linkS4class{SingleCellExperiment}} object containing numeric expression matrix for the query cells.}

\item{reference_data}{A \code{\linkS4class{SingleCellExperiment}} object containing numeric expression matrix for the reference cells.}

\item{query_cell_type_col}{The column name in the \code{colData} of \code{query_data} that identifies the cell types.}

\item{ref_cell_type_col}{The column name in the \code{colData} of \code{reference_data} that identifies the cell types.}

\item{cell_types}{A character vector specifying the cell types to analyze. If NULL, all common cell types are used.}

\item{pc_subset}{A numeric vector specifying which principal components to plot. Default is 1:3.}

\item{n_top_loadings}{Number of top loading genes to analyze per PC. Default is 50.}

\item{p_value_threshold}{P-value threshold for statistical significance. Default is 0.05.}

\item{adjust_method}{Method for multiple testing correction. Default is "fdr".}

\item{assay_name}{Name of the assay on which to perform computations. Default is "logcounts".}

\item{max_cells}{Maximum number of cells to retain. If the object has fewer cells, it is returned unchanged.
Default is 2500.}

\item{x}{An object of class \code{calculateTopLoadingGeneShiftsObject} containing the output of the \code{calculateTopLoadingGeneShifts} function.}

\item{cell_type}{A character string specifying the cell type to plot (must be exactly one).}

\item{plot_by}{A character string specifying gene selection method. Either "top_loading" or "p_adjusted". Default is "p_adjusted".}

\item{n_genes}{Number of genes to show per PC. Default is 10.}

\item{significance_threshold}{P-adjusted threshold for significance annotation. Default is 0.05.}

\item{...}{Additional arguments to be passed to the plotting functions.}
}
\value{
A list containing:
\itemize{
  \item PC results: Named elements for each PC (e.g., "PC1", "PC2") containing data frames with analysis results
  \item expression_data: Matrix of expression values for all analyzed genes (genes Ã— cells)
  \item cell_metadata: Data frame with columns: cell_id, dataset, cell_type, original_index
  \item gene_metadata: Data frame with columns: gene, pc, loading for all analyzed genes
  \item percent_var: Named numeric vector of percent variance explained for each analyzed PC
}

Each PC data frame contains columns:
\itemize{
  \item gene: Gene symbol
  \item loading: PC loading value for the gene
  \item cell_type: Cell type analyzed
  \item p_value: Raw p-value from Wilcoxon rank-sum test
  \item p_adjusted: Adjusted p-value
  \item mean_query: Mean expression in query data
  \item mean_reference: Mean expression in reference data
  \item significant: Logical indicating statistical significance
}

A ggplot object showing boxplots of gene expression by PC and dataset.
}
\description{
This function identifies genes with the highest loadings for specified principal components
and performs statistical tests to detect distributional differences between query and reference data.

This function creates boxplots showing expression distributions for top loading genes
that exhibit distributional differences between query and reference datasets.
}
\details{
This function extracts the top loading genes for each specified principal component from the reference
PCA space and performs distributional comparisons between query and reference data. For each gene,
it performs statistical tests to identify genes that may be causing PC-specific alignment issues
between datasets.

This function visualizes the results from \code{calculateTopLoadingGeneShifts} by creating
faceted boxplots. Each facet represents a principal component with its variance explained.
Within each facet, boxplots show expression distributions for selected genes, comparing
query and reference datasets for a specific cell type. Genes can be selected either by
highest absolute loadings or most significant p-adjusted values.
}
\examples{
# Load data
data("reference_data")
data("query_data")

# Compute distributional shifts for genes with top loadings
gene_shifts <- calculateTopLoadingGeneShifts(reference_data = reference_data,
                                             query_data = query_data,
                                             query_cell_type_col = "SingleR_annotation",
                                             ref_cell_type_col = "expert_annotation",
                                             cell_types = NULL,
                                             pc_subset = 1:3,
                                             n_top_loadings = 50,
                                             assay_name = "logcounts",
                                             p_value_threshold = 0.05,
                                             adjust_method = "fdr")

# Plot gene shifts
plot(gene_shifts,
     cell_type = "CD8",
     pc_subset = 1:3,
     plot_by = "p_adjusted",
     n_genes = 10,
     significance_threshold = 0.05)

}
\seealso{
\code{\link{plot.calculateTopLoadingGeneShiftsObject}}

\code{\link{calculateTopLoadingGeneShifts}}
}
\author{
Anthony Christidis, \email{anthony-alexander_christidis@hms.harvard.edu}
}
